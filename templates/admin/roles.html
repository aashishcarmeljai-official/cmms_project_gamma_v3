{% extends 'base.html' %}

{% block title %}Role Management - Admin{% endblock %}

{% block extra_head %}
<style>
    .role-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .role-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .permission-badge {
        font-size: 0.75rem;
        margin: 0.1rem;
    }
    .system-role {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        color: white;
    }
    .custom-role {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }
    .modal-header.system-role {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        color: white;
    }
    .modal-header.custom-role {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid admin-page">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Role Management</h1>
            <p class="text-muted">Manage user roles and permissions</p>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRoleModal">
                <i class="fas fa-plus me-2"></i>Create Role
            </button>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Admin
            </a>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-white">Search & Filter</h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <!-- First Row -->
                <div class="col-lg-4 col-md-6">
                    <label for="search" class="form-label fw-bold">Search</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="{{ filters.search }}" placeholder="Role name, display name, or description">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="type_filter" class="form-label fw-bold">Type</label>
                    <select class="form-select" id="type_filter" name="type">
                        <option value="">All Types</option>
                        <option value="system" {{ 'selected' if filters.type == 'system' }}>System Roles</option>
                        <option value="custom" {{ 'selected' if filters.type == 'custom' }}>Custom Roles</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="status_filter" class="form-label fw-bold">Status</label>
                    <select class="form-select" id="status_filter" name="status">
                        <option value="">All Status</option>
                        <option value="active" {{ 'selected' if filters.status == 'active' }}>Active</option>
                        <option value="inactive" {{ 'selected' if filters.status == 'inactive' }}>Inactive</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="permission_filter" class="form-label fw-bold">Permission</label>
                    <select class="form-select" id="permission_filter" name="permission">
                        <option value="">All Permissions</option>
                        <option value="admin_dashboard" {{ 'selected' if filters.permission == 'admin_dashboard' }}>Admin Dashboard</option>
                        <option value="user_manage" {{ 'selected' if filters.permission == 'user_manage' }}>User Management</option>
                        <option value="equipment_manage" {{ 'selected' if filters.permission == 'equipment_manage' }}>Equipment Management</option>
                        <option value="workorder_manage" {{ 'selected' if filters.permission == 'workorder_manage' }}>Work Order Management</option>
                        <option value="role_manage" {{ 'selected' if filters.permission == 'role_manage' }}>Role Management</option>
                        <option value="team_manage" {{ 'selected' if filters.permission == 'team_manage' }}>Team Management</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="sort_by" class="form-label fw-bold">Sort By</label>
                    <select class="form-select" id="sort_by" name="sort">
                        <option value="name" {{ 'selected' if filters.sort == 'name' }}>Name</option>
                        <option value="display_name" {{ 'selected' if filters.sort == 'display_name' }}>Display Name</option>
                        <option value="created_at" {{ 'selected' if filters.sort == 'created_at' }}>Created Date</option>
                    </select>
                </div>
                
                <!-- Second Row -->
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                        <a href="{{ url_for('admin_roles') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Clear Filters
                        </a>
                        <button type="button" class="btn btn-outline-info" onclick="toggleAdvancedFilters()">
                            <i class="fas fa-cog me-2"></i>Advanced Options
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Filter Buttons -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-white">Quick Filters</h6>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="applyQuickFilter('system')">
                            <i class="fas fa-cogs me-1"></i>System Roles
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="applyQuickFilter('custom')">
                            <i class="fas fa-user-edit me-1"></i>Custom Roles
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="applyQuickFilter('active')">
                            <i class="fas fa-check-circle me-1"></i>Active Roles
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="applyQuickFilter('inactive')">
                            <i class="fas fa-times-circle me-1"></i>Inactive Roles
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="applyQuickFilter('admin')">
                            <i class="fas fa-shield-alt me-1"></i>Admin Roles
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Roles
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ roles|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-shield fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Active Roles
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ active_roles_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                System Roles
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ system_roles_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-cogs fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Custom Roles
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ custom_roles_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-edit fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Roles Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-white">Roles ({{ roles|length }} total)</h6>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-success btn-sm" onclick="bulkActivate()">
                    <i class="fas fa-check me-1"></i>Activate Selected
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" onclick="bulkDeactivate()">
                    <i class="fas fa-times me-1"></i>Deactivate Selected
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if roles %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                    <thead class="table-dark">
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Role</th>
                            <th>Type</th>
                            <th>Permissions</th>
                            <th>Users</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr>
                            <td>
                                {% if not role.is_system_role %}
                                <input type="checkbox" class="role-checkbox" value="{{ role.id }}">
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar me-3">
                                        <div class="bg-{{ 'primary' if role.is_system_role else 'info' }} text-white rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-{{ 'cogs' if role.is_system_role else 'user-edit' }}"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ role.display_name }}</div>
                                        <div class="text-muted">{{ role.name }}</div>
                                        <small class="text-muted">{{ role.description[:50] }}{{ '...' if role.description|length > 50 else '' }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'primary' if role.is_system_role else 'info' }}">
                                    {{ 'System' if role.is_system_role else 'Custom' }}
                                </span>
                            </td>
                            <td>
                                {% if role.permissions %}
                                {% set permissions = role.permissions|from_json %}
                                {% for permission in permissions[:3] %}
                                <span class="badge bg-light text-dark me-1 mb-1">{{ permission }}</span>
                                {% endfor %}
                                {% if permissions|length > 3 %}
                                <span class="badge bg-secondary me-1 mb-1">+{{ permissions|length - 3 }} more</span>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">No permissions</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ role_user_counts[role.id] }}</span>
                                <small class="text-muted d-block">users</small>
                                {% if role_user_counts[role.id] > 0 %}
                                <button class="btn btn-sm btn-outline-info mt-1" 
                                        onclick="viewRoleUsers({{ role.id }}, '{{ role.display_name }}')" 
                                        title="View users with this role">
                                    <i class="fas fa-users"></i> View
                                </button>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if role.is_active else 'danger' }}">
                                    {{ 'Active' if role.is_active else 'Inactive' }}
                                </span>
                            </td>
                            <td>
                                <div>{{ role.created_at.strftime('%Y-%m-%d') }}</div>
                                <small class="text-muted">{{ role.created_at.strftime('%H:%M') }}</small>
                            </td>
                            <td>
                                <div class="btn-group-vertical btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="viewRole({{ role.id }})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {% if not role.is_system_role %}
                                    <button class="btn btn-outline-warning btn-sm" 
                                            onclick="editRole({{ role.id }})" title="Edit Role">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" 
                                            onclick="deleteRole({{ role.id }})" title="Delete Role">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-user-shield fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No roles found</h5>
                <p class="text-muted">Try adjusting your search criteria or create a new role.</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRoleModal">
                    <i class="fas fa-plus me-2"></i>Create First Role
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Create New Role
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createRoleForm" method="POST" action="{{ url_for('admin_create_role') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="roleName" class="form-label">Role Name *</label>
                                <input type="text" class="form-control" id="roleName" name="name" required 
                                       placeholder="e.g., senior_technician">
                                <div class="form-text">Use lowercase with underscores (e.g., senior_technician)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="displayName" class="form-label">Display Name *</label>
                                <input type="text" class="form-control" id="displayName" name="display_name" required 
                                       placeholder="e.g., Senior Technician">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="roleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="roleDescription" name="description" rows="3" 
                                  placeholder="Describe the role's responsibilities and access level"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Equipment Management</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="equipment_view" id="equipment_view">
                                    <label class="form-check-label" for="equipment_view">View Equipment</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="equipment_create" id="equipment_create">
                                    <label class="form-check-label" for="equipment_create">Create Equipment</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="equipment_edit" id="equipment_edit">
                                    <label class="form-check-label" for="equipment_edit">Edit Equipment</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="equipment_delete" id="equipment_delete">
                                    <label class="form-check-label" for="equipment_delete">Delete Equipment</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="equipment_manage" id="equipment_manage">
                                    <label class="form-check-label" for="equipment_manage">Full Equipment Management</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Work Order Management</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="workorder_view_all" id="workorder_view_all">
                                    <label class="form-check-label" for="workorder_view_all">View All Work Orders</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="workorder_view_assigned_only" id="workorder_view_assigned_only">
                                    <label class="form-check-label" for="workorder_view_assigned_only">View Assigned/Team Work Orders</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="workorder_create" id="workorder_create">
                                    <label class="form-check-label" for="workorder_create">Create Work Orders</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="workorder_edit" id="workorder_edit">
                                    <label class="form-check-label" for="workorder_edit">Edit Work Orders</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="workorder_delete" id="workorder_delete">
                                    <label class="form-check-label" for="workorder_delete">Delete Work Orders</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="workorder_manage" id="workorder_manage">
                                    <label class="form-check-label" for="workorder_manage">Full Work Order Management</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="bulk_assign" id="bulk_assign">
                                    <label class="form-check-label" for="bulk_assign">Bulk Assign Work Orders</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="bulk_status_update" id="bulk_status_update">
                                    <label class="form-check-label" for="bulk_status_update">Bulk Status Update</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>User Management</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="user_view" id="user_view">
                                    <label class="form-check-label" for="user_view">View Users</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="user_create" id="user_create">
                                    <label class="form-check-label" for="user_create">Create Users</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="user_edit" id="user_edit">
                                    <label class="form-check-label" for="user_edit">Edit Users</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="user_delete" id="user_delete">
                                    <label class="form-check-label" for="user_delete">Delete Users</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="user_manage" id="user_manage">
                                    <label class="form-check-label" for="user_manage">Full User Management</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Role & Permission Management</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="role_view" id="role_view">
                                    <label class="form-check-label" for="role_view">View Roles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="role_create" id="role_create">
                                    <label class="form-check-label" for="role_create">Create Roles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="role_edit" id="role_edit">
                                    <label class="form-check-label" for="role_edit">Edit Roles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="role_delete" id="role_delete">
                                    <label class="form-check-label" for="role_delete">Delete Roles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="role_manage" id="role_manage">
                                    <label class="form-check-label" for="role_manage">Full Role Management</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Team Management</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="team_view" id="team_view">
                                    <label class="form-check-label" for="team_view">View Teams</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="team_create" id="team_create">
                                    <label class="form-check-label" for="team_create">Create Teams</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="team_edit" id="team_edit">
                                    <label class="form-check-label" for="team_edit">Edit Teams</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="team_delete" id="team_delete">
                                    <label class="form-check-label" for="team_delete">Delete Teams</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="team_manage" id="team_manage">
                                    <label class="form-check-label" for="team_manage">Full Team Management</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Inventory Management</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="inventory_view" id="inventory_view">
                                    <label class="form-check-label" for="inventory_view">View Inventory</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="inventory_create" id="inventory_create">
                                    <label class="form-check-label" for="inventory_create">Create Inventory</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="inventory_edit" id="inventory_edit">
                                    <label class="form-check-label" for="inventory_edit">Edit Inventory</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="inventory_delete" id="inventory_delete">
                                    <label class="form-check-label" for="inventory_delete">Delete Inventory</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="inventory_manage" id="inventory_manage">
                                    <label class="form-check-label" for="inventory_manage">Full Inventory Management</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Location Management</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="location_view" id="location_view">
                                    <label class="form-check-label" for="location_view">View Locations</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="location_create" id="location_create">
                                    <label class="form-check-label" for="location_create">Create Locations</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="location_edit" id="location_edit">
                                    <label class="form-check-label" for="location_edit">Edit Locations</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="location_delete" id="location_delete">
                                    <label class="form-check-label" for="location_delete">Delete Locations</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="location_manage" id="location_manage">
                                    <label class="form-check-label" for="location_manage">Full Location Management</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>SOP Management</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="sop_view" id="sop_view">
                                    <label class="form-check-label" for="sop_view">View SOPs</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="sop_create" id="sop_create">
                                    <label class="form-check-label" for="sop_create">Create SOPs</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="sop_edit" id="sop_edit">
                                    <label class="form-check-label" for="sop_edit">Edit SOPs</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="sop_delete" id="sop_delete">
                                    <label class="form-check-label" for="sop_delete">Delete SOPs</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="sop_manage" id="sop_manage">
                                    <label class="form-check-label" for="sop_manage">Full SOP Management</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Reporting & Analytics</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="reports_access" id="reports_access">
                                    <label class="form-check-label" for="reports_access">Access Reports & Analytics</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="reports_export" id="reports_export">
                                    <label class="form-check-label" for="reports_export">Export Reports/Data</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>System Administration</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="admin_dashboard" id="admin_dashboard">
                                    <label class="form-check-label" for="admin_dashboard">Admin Dashboard</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="system_settings" id="system_settings">
                                    <label class="form-check-label" for="system_settings">System Settings</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="maintenance_mode" id="maintenance_mode">
                                    <label class="form-check-label" for="maintenance_mode">Enable Maintenance Mode</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="backup_restore" id="backup_restore">
                                    <label class="form-check-label" for="backup_restore">Backup & Restore</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="notification_manage" id="notification_manage">
                                    <label class="form-check-label" for="notification_manage">Manage Notifications</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions" value="whatsapp_manage" id="whatsapp_manage">
                                    <label class="form-check-label" for="whatsapp_manage">Manage WhatsApp Integration</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Create Role
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Role
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editRoleForm" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editRoleName" class="form-label">Role Name *</label>
                                <input type="text" class="form-control" id="editRoleName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDisplayName" class="form-label">Display Name *</label>
                                <input type="text" class="form-control" id="editDisplayName" name="display_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editRoleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editRoleDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div id="editPermissionsContainer">
                            <!-- Permissions will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Role
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Role Modal -->
<div class="modal fade" id="viewRoleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Role Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="roleDetails">
                    <!-- Role details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Role Confirmation Modal -->
<div class="modal fade" id="deleteRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Role
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this role?</p>
                <p class="text-muted">This action cannot be undone. Users with this role will need to be reassigned.</p>
                <form id="deleteRoleForm" method="POST">
                    <div class="mb-3">
                        <label for="reassignRole" class="form-label">Reassign users to:</label>
                        <select class="form-select" id="reassignRole" name="reassign_role_id" required>
                            <option value="">Select Role</option>
                            {% for role in roles %}
                                <option value="{{ role.id }}">{{ role.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deleteRoleForm" class="btn btn-danger">
                    <i class="fas fa-trash me-2"></i>Delete Role
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle select all checkboxes
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.role-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Bulk operations
function bulkActivate() {
    const selectedRoles = getSelectedRoles();
    if (selectedRoles.length === 0) {
        alert('Please select roles to activate.');
        return;
    }
    // Implement bulk activate functionality
    console.log('Activate roles:', selectedRoles);
}

function bulkDeactivate() {
    const selectedRoles = getSelectedRoles();
    if (selectedRoles.length === 0) {
        alert('Please select roles to deactivate.');
        return;
    }
    // Implement bulk deactivate functionality
    console.log('Deactivate roles:', selectedRoles);
}

function getSelectedRoles() {
    const checkboxes = document.querySelectorAll('.role-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Role operations
function viewRole(roleId) {
    fetch(`/admin/roles/${roleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const role = data.role;
                const permissions = role.permissions ? JSON.parse(role.permissions) : [];
                
                document.getElementById('roleDetails').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <p><strong>Name:</strong> ${role.name}</p>
                            <p><strong>Display Name:</strong> ${role.display_name}</p>
                            <p><strong>Description:</strong> ${role.description || 'No description'}</p>
                            <p><strong>Status:</strong> <span class="badge ${role.is_active ? 'bg-success' : 'bg-secondary'}">${role.is_active ? 'Active' : 'Inactive'}</span></p>
                            <p><strong>Type:</strong> <span class="badge ${role.is_system_role ? 'bg-primary' : 'bg-info'}">${role.is_system_role ? 'System Role' : 'Custom Role'}</span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Permissions (${permissions.length})</h6>
                            ${permissions.length > 0 ? permissions.map(p => `<span class="badge bg-light text-dark me-1 mb-1">${p}</span>`).join('') : '<p class="text-muted">No permissions assigned</p>'}
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Timestamps</h6>
                            <p><strong>Created:</strong> ${new Date(role.created_at).toLocaleDateString()}</p>
                            <p><strong>Updated:</strong> ${new Date(role.updated_at).toLocaleDateString()}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Users with this role</h6>
                            <p><strong>Count:</strong> ${role.users_count || 0}</p>
                        </div>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('viewRoleModal')).show();
            } else {
                alert('Error loading role details');
            }
        });
}

function editRole(roleId) {
    fetch(`/admin/roles/${roleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const role = data.role;
                const permissions = role.permissions ? JSON.parse(role.permissions) : [];
                
                document.getElementById('editRoleForm').action = `/admin/roles/${roleId}/update`;
                document.getElementById('editRoleName').value = role.name;
                document.getElementById('editDisplayName').value = role.display_name;
                document.getElementById('editRoleDescription').value = role.description || '';
                
                // Load permissions
                loadPermissionsToEdit(permissions);
                
                new bootstrap.Modal(document.getElementById('editRoleModal')).show();
            } else {
                alert('Error loading role details');
            }
        });
}

function loadPermissionsToEdit(selectedPermissions) {
    const container = document.getElementById('editPermissionsContainer');
    const allPermissions = [
        'equipment_view', 'equipment_create', 'equipment_edit', 'equipment_delete', 'equipment_manage',
        'workorder_view_all', 'workorder_view_assigned_only', 'workorder_create', 'workorder_edit', 'workorder_delete', 'workorder_manage', 'bulk_assign', 'bulk_status_update',
        'user_view', 'user_create', 'user_edit', 'user_delete', 'user_manage',
        'role_view', 'role_create', 'role_edit', 'role_delete', 'role_manage',
        'team_view', 'team_create', 'team_edit', 'team_delete', 'team_manage',
        'inventory_view', 'inventory_create', 'inventory_edit', 'inventory_delete', 'inventory_manage',
        'location_view', 'location_create', 'location_edit', 'location_delete', 'location_manage',
        'sop_view', 'sop_create', 'sop_edit', 'sop_delete', 'sop_manage',
        'reports_access', 'reports_export',
        'admin_dashboard', 'system_settings', 'maintenance_mode', 'backup_restore', 'notification_manage', 'whatsapp_manage'
    ];
    const categories = {
        'Equipment Management': ['equipment_view', 'equipment_create', 'equipment_edit', 'equipment_delete', 'equipment_manage'],
        'Work Order Management': ['workorder_view_all', 'workorder_view_assigned_only', 'workorder_create', 'workorder_edit', 'workorder_delete', 'workorder_manage', 'bulk_assign', 'bulk_status_update'],
        'User Management': ['user_view', 'user_create', 'user_edit', 'user_delete', 'user_manage'],
        'Role & Permission Management': ['role_view', 'role_create', 'role_edit', 'role_delete', 'role_manage'],
        'Team Management': ['team_view', 'team_create', 'team_edit', 'team_delete', 'team_manage'],
        'Inventory Management': ['inventory_view', 'inventory_create', 'inventory_edit', 'inventory_delete', 'inventory_manage'],
        'Location Management': ['location_view', 'location_create', 'location_edit', 'location_delete', 'location_manage'],
        'SOP Management': ['sop_view', 'sop_create', 'sop_edit', 'sop_delete', 'sop_manage'],
        'Reporting & Analytics': ['reports_access', 'reports_export'],
        'System Administration': ['admin_dashboard', 'system_settings', 'maintenance_mode', 'backup_restore', 'notification_manage', 'whatsapp_manage']
    };
    let html = '';
    for (const [category, perms] of Object.entries(categories)) {
        html += `<div class="row mb-3"><div class="col-12"><h6>${category}</h6>`;
        perms.forEach(perm => {
            const isChecked = selectedPermissions.includes(perm) ? 'checked' : '';
            html += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="permissions" value="${perm}" id="edit_${perm}" ${isChecked}>
                    <label class="form-check-label" for="edit_${perm}">${perm.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label>
                </div>
            `;
        });
        html += '</div></div>';
    }
    container.innerHTML = html;
}

function deleteRole(roleId) {
    document.getElementById('deleteRoleForm').action = `/admin/roles/${roleId}/delete`;
    new bootstrap.Modal(document.getElementById('deleteRoleModal')).show();
}

function viewRoleUsers(roleId, roleName) {
    // Fetch users for this role from the API
    fetch(`/admin/roles/${roleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const roleUsers = data.role.users || [];
                
                let usersHtml = '';
                if (roleUsers.length > 0) {
                    roleUsers.forEach(user => {
                        usersHtml += `
                            <div class="d-flex align-items-center mb-2 p-2 border rounded">
                                <div class="avatar me-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        ${user.first_name ? user.first_name[0] : user.username[0]}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">${user.first_name} ${user.last_name}</div>
                                    <div class="text-muted">${user.email}</div>
                                    <small class="text-muted">@${user.username}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                                        ${user.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    usersHtml = '<p class="text-muted">No users assigned to this role.</p>';
                }
                
                // Show in a modal
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Users with Role: ${roleName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <span class="badge bg-info">${roleUsers.length} users</span>
                                </div>
                                ${usersHtml}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                new bootstrap.Modal(modal).show();
                
                // Clean up modal after it's hidden
                modal.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modal);
                });
            } else {
                alert('Error loading role users');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading role users');
        });
}

// Form validation
document.getElementById('createRoleForm').addEventListener('submit', function(e) {
    const name = document.getElementById('roleName').value;
    const displayName = document.getElementById('displayName').value;
    
    if (!name || !displayName) {
        e.preventDefault();
        alert('Please fill in all required fields');
        return;
    }
    
    // Validate role name format
    if (!/^[a-z_]+$/.test(name)) {
        e.preventDefault();
        alert('Role name must contain only lowercase letters and underscores');
        return;
    }
});

document.getElementById('editRoleForm').addEventListener('submit', function(e) {
    const name = document.getElementById('editRoleName').value;
    const displayName = document.getElementById('editDisplayName').value;
    
    if (!name || !displayName) {
        e.preventDefault();
        alert('Please fill in all required fields');
        return;
    }
    
    // Validate role name format
    if (!/^[a-z_]+$/.test(name)) {
        e.preventDefault();
        alert('Role name must contain only lowercase letters and underscores');
        return;
    }
});

// Search and filter functionality
function applyQuickFilter(filterType) {
    let url = new URL(window.location);
    
    switch(filterType) {
        case 'system':
            url.searchParams.set('type', 'system');
            break;
        case 'custom':
            url.searchParams.set('type', 'custom');
            break;
        case 'active':
            url.searchParams.set('status', 'active');
            break;
        case 'inactive':
            url.searchParams.set('status', 'inactive');
            break;
        case 'admin':
            url.searchParams.set('permission', 'admin_dashboard');
            break;
    }
    
    window.location.href = url.toString();
}

function toggleAdvancedFilters() {
    const advancedFilters = document.querySelectorAll('#sort_by');
    const button = document.querySelector('button[onclick="toggleAdvancedFilters()"]');
    
    advancedFilters.forEach(filter => {
        if (filter.style.display === 'none') {
            filter.style.display = 'block';
            button.innerHTML = '<i class="fas fa-eye-slash me-2"></i>Hide Advanced';
        } else {
            filter.style.display = 'none';
            button.innerHTML = '<i class="fas fa-cog me-2"></i>Advanced Options';
        }
    });
}

// Auto-submit form on filter change
document.addEventListener('DOMContentLoaded', function() {
    const filterInputs = document.querySelectorAll('#search, #type_filter, #status_filter, #permission_filter');
    
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            document.querySelector('form[method="GET"]').submit();
        });
    });
    
    // Initialize advanced filters as hidden by default
    const advancedFilters = document.querySelectorAll('#sort_by');
    advancedFilters.forEach(filter => {
        filter.style.display = 'none';
    });
});
</script>
{% endblock %} 