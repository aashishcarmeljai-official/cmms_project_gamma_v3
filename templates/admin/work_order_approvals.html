{% extends 'base.html' %}
{% block title %}Work Order Approvals{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Work Order Approvals</h2>
    {% if requests %}
    <table class="table table-bordered table-hover mt-3">
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Equipment</th>
                <th>Priority</th>
                <th>Type</th>
                <th>Requested By</th>
                <th>Submitted</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requests %}
            <tr id="req-row-{{ req.id }}">
                <td>{{ req.title }}</td>
                <td>{{ req.description }}</td>
                <td>{{ req.equipment.name if req.equipment else 'N/A' }}</td>
                <td>{{ req.priority|capitalize }}</td>
                <td>{{ req.type|capitalize }}</td>
                <td>{{ req.requested_by.first_name }} {{ req.requested_by.last_name }}</td>
                <td>{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <form class="d-inline-block" onsubmit="return approveRequest({{ req.id }}, this);">
                        <button type="submit" class="btn btn-success btn-sm">Approve</button>
                    </form>
                    <form class="d-inline-block" onsubmit="return rejectRequest({{ req.id }}, this);">
                        <input type="text" name="rejection_reason" class="form-control form-control-sm mb-1" placeholder="Reason (optional)">
                        <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info mt-4">No pending work order requests.</div>
    {% endif %}
</div>
<script>
function approveRequest(id, form) {
    fetch(`/admin/work-order-approvals/${id}/approve`, {method: 'POST'})
        .then(r => r.json()).then(data => {
            if(data.success) {
                document.getElementById('req-row-' + id).remove();
                alert('Request approved and work order created.');
            } else {
                alert(data.message || 'Error.');
            }
        });
    return false;
}
function rejectRequest(id, form) {
    const fd = new FormData(form);
    fetch(`/admin/work-order-approvals/${id}/reject`, {method: 'POST', body: fd})
        .then(r => r.json()).then(data => {
            if(data.success) {
                document.getElementById('req-row-' + id).remove();
                alert('Request rejected.');
            } else {
                alert(data.message || 'Error.');
            }
        });
    return false;
}
</script>
{% endblock %} 