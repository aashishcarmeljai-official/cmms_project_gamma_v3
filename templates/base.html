<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Maintain Desk{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Ensure dropdowns work properly across all pages */
        .dropdown-menu {
            z-index: 1050 !important;
            position: absolute !important;
            transform: none !important;
            top: 100% !important;
            left: auto !important;
            right: 0 !important;
            margin-top: 0.125rem !important;
            min-width: 10rem !important;
            max-width: 20rem !important;
        }
        
        .navbar .dropdown-menu {
            z-index: 1051 !important;
        }
        
        .dropdown {
            position: relative;
        }
        
        /* Fix any potential display issues */
        .dropdown-menu.show {
            display: block !important;
        }
        
        /* Ensure dropdowns don't go outside viewport */
        .navbar-nav .dropdown-menu {
            position: absolute !important;
            right: 0 !important;
            left: auto !important;
            transform: none !important;
        }
        
        /* For right-aligned dropdowns in navbar */
        .navbar-nav .dropdown-menu.dropdown-menu-end {
            right: 0 !important;
            left: auto !important;
        }
        
        /* Prevent dropdown from going off-screen */
        @media (max-width: 991.98px) {
            .navbar-nav .dropdown-menu {
                position: static !important;
                float: none !important;
                width: auto !important;
                margin-top: 0 !important;
                background-color: transparent !important;
                border: 0 !important;
                box-shadow: none !important;
            }
        }
        /* Uniform dropdowns in admin pages */
        .admin-page .form-select {
            height: 38px;
            font-size: 1rem;
            vertical-align: middle;
            padding-top: 0.375rem;
            padding-bottom: 0.375rem;
        }
        .admin-page label.form-label {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        /* Only keep offcanvas-admin styles below */
        .offcanvas-admin {
            background: linear-gradient(135deg, #0d6efd 0%, #2563eb 100%);
            color: #fff;
            overflow: hidden;
        }
        .offcanvas-admin .offcanvas-title {
            color: #fff;
        }
        .offcanvas-admin .list-group-item a {
            color: #fff !important;
            text-decoration: none !important;
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0;
        }
        .offcanvas-admin .list-group-item {
            background: transparent;
            color: #fff;
            border: none;
            font-size: 1.08rem;
            transition: background 0.2s, color 0.2s;
            padding: 0.45rem 1.3rem 0.45rem 1.3rem;
            display: flex;
            align-items: center;
            margin-bottom: 0;
            gap: 0.7rem;
        }
        .offcanvas-admin .list-group-item i {
            font-size: 1.18rem;
            margin-right: 0.85rem;
            min-width: 1.5em;
            text-align: left;
        }
        .offcanvas-admin .list-group-item:hover, .offcanvas-admin .list-group-item:focus {
            background: rgba(255,255,255,0.10);
            color: #e3f2fd;
        }
        .offcanvas-admin .section-header {
            font-size: 0.97rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: #e3f2fd;
            background: rgba(255,255,255,0.07);
            border-radius: 0.25rem;
            margin: 1.2rem 0 0.5rem 1.5rem;
            padding: 0.25rem 0.75rem;
        }
        .offcanvas-admin hr.dropdown-divider {
            border-top: 1px solid #e3f2fd;
            margin: 0.5rem 0;
        }
        .offcanvas-admin .sidebar-scrollable {
            overflow-y: auto;
            min-height: 0;
            max-height: calc(100vh - 220px);
            scrollbar-width: none; /* Firefox */
        }
        .offcanvas-admin .sidebar-scrollable::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .sidebar-scrollable {
            position: relative;
        }
        .sidebar-scroll-fade {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 32px;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(13,110,253,0) 0%, rgba(13,110,253,0.7) 100%);
            z-index: 2;
            display: none;
        }
        .sidebar-scrollable.has-scroll .sidebar-scroll-fade {
            display: block;
        }
        .sidebar-scroll-arrow {
            position: absolute;
            left: 50%;
            bottom: 8px;
            transform: translateX(-50%);
            color: #e3f2fd;
            font-size: 1.2rem;
            opacity: 0.8;
            z-index: 3;
            pointer-events: none;
            display: none;
        }
        .sidebar-scrollable.has-scroll .sidebar-scroll-arrow {
            display: block;
        }
        .sideout-panel {
            position: fixed;
            top: 0;
            left: 260px;
            width: 260px;
            height: 100vh;
            background: linear-gradient(135deg, #0d6efd 0%, #2563eb 100%);
            color: #fff;
            z-index: 1050;
            box-shadow: 2px 0 8px rgba(0,0,0,0.07);
            transition: left 0.3s cubic-bezier(.4,0,.2,1);
            border-radius: 0;
        }
        .sideout-panel .list-group-item {
            background: transparent;
            color: #fff;
            border: none;
            font-size: 1.08rem;
            transition: background 0.2s, color 0.2s;
            padding: 0.45rem 1.3rem 0.45rem 1.3rem;
            display: flex;
            align-items: center;
            margin-bottom: 0;
            gap: 0.7rem;
        }
        .sideout-panel .list-group-item a {
            color: #fff !important;
            text-decoration: none !important;
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0;
            gap: 0.7rem;
        }
        .sideout-panel .list-group-item:hover, .sideout-panel .list-group-item:focus {
            background: rgba(255,255,255,0.10);
            color: #e3f2fd;
        }
        .sideout-panel .section-header {
            font-size: 0.97rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: #e3f2fd;
            background: rgba(255,255,255,0.07);
            border-radius: 0.25rem;
            margin: 1.2rem 0 0.5rem 1.5rem;
            padding: 0.25rem 0.75rem;
        }
        .offcanvas-header {
            display: flex;
            align-items: center;
            min-height: 64px;
        }
        .offcanvas-title {
            display: flex;
            align-items: center;
            font-size: 1.25rem;
            font-weight: 700;
            gap: 0.7rem;
        }
        .sideout-header {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            color: #e3f2fd;
            background: rgba(255,255,255,0.07);
            border-radius: 0;
            display: flex;
            align-items: center;
            min-height: 56px;
        }
        .user-team-mgmt-trigger a {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }
        body.sideout-open {
            padding-left: 520px !important;
        }
        .sideout-panel[style*="display: none"] {
            left: -260px !important;
        }
        @media (max-width: 991.98px) {
            .sideout-panel {
                display: none !important;
            }
            body.sideout-open {
                padding-left: 0 !important;
            }
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="alert alert-warning alert-dismissible fade show position-fixed" 
         style="top: 70px; right: 20px; z-index: 9998; display: none;">
        <i class="fas fa-wifi-slash me-2"></i>
        <span id="offlineMessage">Files pending upload</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    {% set minimal_navbar = request.endpoint in ['login', 'signup'] %}
    {% if minimal_navbar %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand me-3" href="/">
                <i class="fas fa-tools me-2"></i>Maintain Desk
            </a>
                <div class="d-flex ms-auto">
                    <div class="nav-item">
                        <a class="nav-link text-white" href="{{ url_for('login') }}">Sign In</a>
                    </div>
                    <div class="nav-item ms-3">
                        <a class="nav-link text-white" href="{{ url_for('signup') }}">Sign Up</a>
                    </div>
                </div>
        </div>
    </nav>
    {% endif %}

    {% if not minimal_navbar and current_user.is_authenticated %}
        {% if current_user.role in ['admin', 'manager'] %}
            <!-- Admin/Manager Sidebar -->
            <div class="fixed-sidebar offcanvas-admin d-flex flex-column" style="position:fixed;top:0;left:0;height:100vh;width:260px;z-index:1040;box-shadow:2px 0 8px rgba(0,0,0,0.07);border-radius:0;">
        <div class="offcanvas-header" style="background:linear-gradient(135deg,#0d6efd 0%,#2563eb 100%);padding:1.2rem 1rem 1rem 1rem;">
                    <h5 class="offcanvas-title" id="adminSidebarLabel"><i class="fas fa-tools me-2"></i>Maintain Desk</h5>
        </div>
                <div class="flex-grow-1 d-flex flex-column justify-content-between" style="min-height:0;">
                    <div class="sidebar-scrollable" style="overflow-y:auto;min-height:0;max-height:calc(100vh - 220px);">
            <div class="section-header">Core Management</div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="{{ url_for('admin_dashboard') }}"><i class="fas fa-tachometer-alt"></i>Admin Dashboard</a></li>
                <li class="list-group-item p-0 work-orders-mgmt-trigger" style="cursor:pointer;">
                    <a class="d-flex align-items-center" onclick="toggleWorkOrdersMgmtPanel()" style="color:#fff;padding:0.5rem 1.2rem;white-space:nowrap;overflow:hidden;">
                      <i class="fas fa-clipboard-list me-2" style="flex-shrink:0;"></i>
                      <span style="flex:1 1 auto;min-width:0;text-overflow:ellipsis;overflow:hidden;">Work Orders</span>
                      <i class="fas fa-chevron-right ms-auto" style="flex-shrink:0;"></i>
                    </a>
                </li>
                <li class="list-group-item"><a href="{{ url_for('admin_asset_management') }}"><i class="fas fa-cogs"></i>Assets</a></li>
                <li class="list-group-item p-0 user-team-mgmt-trigger" style="cursor:pointer;">
                  <a class="d-flex align-items-center" onclick="toggleUserTeamMgmtPanel()" style="color:#fff;padding:0.5rem 1.2rem;white-space:nowrap;overflow:hidden;">
                    <i class="fas fa-users-cog me-2" style="flex-shrink:0;"></i>
                    <span style="flex:1 1 auto;min-width:0;text-overflow:ellipsis;overflow:hidden;">User/Teams</span>
                    <i class="fas fa-chevron-right ms-auto" style="flex-shrink:0;"></i>
                  </a>
                </li>
                <li class="list-group-item"><a href="/vendors"><i class="fas fa-briefcase"></i>Vendors</a></li>
                <li class="list-group-item"><a href="{{ url_for('admin_departments') }}"><i class="fas fa-building"></i>Departments</a></li>
                <li class="list-group-item"><a href="{{ url_for('categories_list') }}"><i class="fas fa-tags"></i>Categories</a></li>
                <li class="list-group-item"><a href="/locations"><i class="fas fa-map-marker-alt"></i>Locations</a></li>
                <li class="list-group-item"><a href="{{ url_for('admin_technicians') }}"><i class="fas fa-user-cog"></i>Technician Performance</a></li>
            </ul>
            <!-- Sideout panel for Work Orders Management -->
            <div id="workOrdersMgmtSideout" class="sideout-panel" style="display:none;">
              <div class="sideout-header d-flex align-items-center px-3 py-2">
                <span><i class="fas fa-clipboard-list me-2"></i>Work Orders</span>
              </div>
              <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="/work-orders"><i class="fas fa-list"></i>Work Orders</a></li>
                <li class="list-group-item"><a href="{{ url_for('admin_work_orders') }}"><i class="fas fa-user-shield"></i>Advanced</a></li>
                <li class="list-group-item"><a href="{{ url_for('admin_work_order_approvals') }}"><i class="fas fa-check-circle"></i>Work Order Approvals</a></li>
              </ul>
            </div>
            <!-- Sideout panel for User/Team Management -->
            <div id="userTeamMgmtSideout" class="sideout-panel" style="display:none;">
              <div class="sideout-header d-flex align-items-center px-3 py-2">
                <span><i class="fas fa-users-cog me-2"></i>User/Team Management</span>
              </div>
              <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="{{ url_for('admin_users') }}"><i class="fas fa-users"></i>User Management</a></li>
                <li class="list-group-item"><a href="{{ url_for('admin_teams') }}"><i class="fas fa-user-friends"></i>Team Management</a></li>
                <li class="list-group-item"><a href="{{ url_for('admin_roles') }}"><i class="fas fa-user-shield"></i>Role Management</a></li>
              </ul>
            </div>
            <div class="section-header">Analytics & Reports</div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="{{ url_for('admin_analytics') }}"><i class="fas fa-chart-line"></i>Analytics</a></li>
                <li class="list-group-item"><a href="/reports"><i class="fas fa-chart-bar"></i>Reports</a></li>
            </ul>
            <hr class="dropdown-divider">
            <div class="section-header">System & Notifications</div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="{{ url_for('whatsapp_emergency') }}"><i class="fab fa-whatsapp"></i>Emergency Broadcast</a></li>
                <li class="list-group-item"><a href="{{ url_for('whatsapp_notifications') }}"><i class="fas fa-bell"></i>Notification Logs</a></li>
                <li class="list-group-item"><a href="{{ url_for('admin_settings') }}"><i class="fas fa-cogs"></i>System Settings</a></li>
            </ul>
                    </div>
                    <div class="sidebar-user-section mt-2" style="border-top:1px solid #e3f2fd;padding-top:0.5rem;background:rgba(255,255,255,0.03);">
                        <div class="section-header">User</div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><a href="{{ url_for('profile') }}"><i class="fas fa-user-circle"></i>Profile</a></li>
                            <li class="list-group-item"><a href="{{ url_for('whatsapp_settings') }}"><i class="fab fa-whatsapp"></i>WhatsApp Settings</a></li>
                            <li class="list-group-item"><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <style>
                body {
                    padding-left: 260px !important;
                }
                @media (max-width: 991.98px) {
                    .fixed-sidebar {
                        display: none !important;
                    }
                    body {
                        padding-left: 0 !important;
                    }
                }
                main.container-fluid {
                    max-width: 100vw;
                }
            </style>
        {% else %}
            <!-- Regular User Sidebar -->
            <div class="fixed-sidebar offcanvas-admin d-flex flex-column" style="position:fixed;top:0;left:0;height:100vh;width:260px;z-index:1040;box-shadow:2px 0 8px rgba(0,0,0,0.07);border-radius:0;">
                <div class="offcanvas-header" style="background:linear-gradient(135deg,#0d6efd 0%,#2563eb 100%);padding:1.2rem 1rem 1rem 1rem;">
                    <h5 class="offcanvas-title"><i class="fas fa-tools me-2"></i>Maintain Desk</h5>
                </div>
                <div class="flex-grow-1 d-flex flex-column justify-content-between" style="min-height:0;">
                    <div class="sidebar-scrollable" style="overflow-y:auto;min-height:0;max-height:calc(100vh - 220px);">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><a href="/"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
                            <li class="list-group-item"><a href="/equipment"><i class="fas fa-cogs"></i>Equipment</a></li>
                            <li class="list-group-item"><a href="/inventory"><i class="fas fa-boxes"></i>Inventory</a></li>
                            <li class="list-group-item"><a href="/work-orders"><i class="fas fa-clipboard-list"></i>Work Orders</a></li>
                            <li class="list-group-item"><a href="/sops"><i class="fas fa-book"></i>SOPs</a></li>
                            <li class="list-group-item"><a href="/calendar"><i class="fas fa-calendar-alt"></i>Calendar</a></li>
                            <li class="list-group-item"><a href="/teams"><i class="fas fa-users"></i>Teams</a></li>
                            <li class="list-group-item"><a href="/vendors"><i class="fas fa-briefcase"></i>Vendors</a></li>
                            {% if current_user.role == 'manager' %}
                            <li class="list-group-item"><a href="/quick-asset-registry"><i class="fas fa-bolt"></i>Quick Asset Registry</a></li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="sidebar-user-section mt-2" style="border-top:1px solid #e3f2fd;padding-top:0.5rem;background:rgba(255,255,255,0.03);">
                        <div class="section-header">User</div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><a href="/my-work-order-requests"><i class="fas fa-question-circle"></i>My Requests</a></li>
                            <li class="list-group-item"><a href="{{ url_for('profile') }}"><i class="fas fa-user-circle"></i>Profile</a></li>
                            <li class="list-group-item"><a href="{{ url_for('whatsapp_settings') }}"><i class="fab fa-whatsapp"></i>WhatsApp Settings</a></li>
                            <li class="list-group-item"><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i>Logout</a></li>
                        </ul>
                    </div>
        </div>
    </div>
    <style>
        body {
            padding-left: 260px !important;
        }
        @media (max-width: 991.98px) {
            .fixed-sidebar {
                display: none !important;
            }
            body {
                padding-left: 0 !important;
            }
        }
        main.container-fluid {
            max-width: 100vw;
        }
    </style>
    {% endif %}
    {% endif %}

    <main class="container-fluid mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/media-upload.js') }}"></script>
    <script>
        // Ensure all dropdowns are properly initialized
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all dropdowns
            var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
            var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl);
            });
            
            // Handle dropdown positioning to prevent overflow
            document.addEventListener('show.bs.dropdown', function(event) {
                var dropdownMenu = event.target.querySelector('.dropdown-menu');
                if (dropdownMenu) {
                    // Check if dropdown would overflow the right edge
                    var rect = dropdownMenu.getBoundingClientRect();
                    var viewportWidth = window.innerWidth;
                    
                    if (rect.right > viewportWidth) {
                        dropdownMenu.style.right = '0';
                        dropdownMenu.style.left = 'auto';
                    }
                    
                    // Check if dropdown would overflow the bottom edge
                    if (rect.bottom > window.innerHeight) {
                        dropdownMenu.style.top = 'auto';
                        dropdownMenu.style.bottom = '100%';
                        dropdownMenu.style.marginTop = '0';
                        dropdownMenu.style.marginBottom = '0.125rem';
                    }
                }
            });
            
            // Debug: Log dropdown elements
            console.log('Base template - Dropdown elements found:', dropdownElementList.length);
        });
        function toggleUserTeamMgmtPanel() {
            var userTeamsPanel = document.getElementById('userTeamMgmtSideout');
            var workOrdersPanel = document.getElementById('workOrdersMgmtSideout');
            if (userTeamsPanel.style.display === 'none' || userTeamsPanel.style.display === '') {
                userTeamsPanel.style.display = 'block';
                document.body.classList.add('sideout-open');
                // Close Work Orders panel if open
                if (workOrdersPanel && workOrdersPanel.style.display === 'block') {
                    workOrdersPanel.style.display = 'none';
                }
            } else {
                userTeamsPanel.style.display = 'none';
                document.body.classList.remove('sideout-open');
            }
        }
        function toggleWorkOrdersMgmtPanel() {
            var workOrdersPanel = document.getElementById('workOrdersMgmtSideout');
            var userTeamsPanel = document.getElementById('userTeamMgmtSideout');
            if (workOrdersPanel.style.display === 'none' || workOrdersPanel.style.display === '') {
                workOrdersPanel.style.display = 'block';
                document.body.classList.add('sideout-open');
                // Close User/Teams panel if open
                if (userTeamsPanel && userTeamsPanel.style.display === 'block') {
                    userTeamsPanel.style.display = 'none';
                }
            } else {
                workOrdersPanel.style.display = 'none';
                document.body.classList.remove('sideout-open');
            }
        }
        // Show scroll cue if sidebar is scrollable
        function updateSidebarScrollCue() {
            var scrollables = document.querySelectorAll('.sidebar-scrollable');
            scrollables.forEach(function(scrollable) {
                if (scrollable.scrollHeight > scrollable.clientHeight + 2) {
                    scrollable.classList.add('has-scroll');
                } else {
                    scrollable.classList.remove('has-scroll');
                }
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            updateSidebarScrollCue();
            window.addEventListener('resize', updateSidebarScrollCue);
            var scrollables = document.querySelectorAll('.sidebar-scrollable');
            scrollables.forEach(function(scrollable) {
                scrollable.addEventListener('scroll', function() {
                    updateSidebarScrollCue();
                });
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html> 