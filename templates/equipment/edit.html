{% extends 'base.html' %}

{% block title %}Edit Equipment - CMMS{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/equipment">Equipment</a></li>
                    <li class="breadcrumb-item"><a href="/equipment/{{ equipment.id }}">{{ equipment.name }}</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-edit text-primary me-2"></i>
                        Edit Equipment
                    </h1>
                    <p class="text-muted">Update equipment information</p>
                </div>
                <a href="/equipment/{{ equipment.id }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Details
                </a>
            </div>
        </div>
    </div>

    <!-- Equipment Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Equipment Information
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/equipment/{{ equipment.id }}/edit">
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-md-6">
                                <h6 class="mb-3">Basic Information</h6>
                                
                                <div class="mb-3">
                                    <label for="name" class="form-label">Equipment Name *</label>
                                    <input type="text" class="form-control" id="name" name="name" value="{{ equipment.name }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="equipment_id" class="form-label">Equipment ID *</label>
                                    <input type="text" class="form-control" id="equipment_id" name="equipment_id" value="{{ equipment.equipment_id }}" required>
                                    <div class="form-text">Unique identifier for the equipment</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="category" class="form-label">Category *</label>
                                    <div class="input-group">
                                        <select class="form-select" id="category" name="category" required>
                                            <option value="">Select Category</option>
                                            {% for category in categories %}
                                                <option value="{{ category.name }}" {{ 'selected' if category.name == equipment.category else '' }}>
                                                    {{ category.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="criticality" class="form-label">Criticality Level</label>
                                    <select class="form-select" id="criticality" name="criticality">
                                        <option value="low" {{ 'selected' if equipment.criticality == 'low' else '' }}>Low</option>
                                        <option value="medium" {{ 'selected' if equipment.criticality == 'medium' else '' }}>Medium</option>
                                        <option value="high" {{ 'selected' if equipment.criticality == 'high' else '' }}>High</option>
                                        <option value="critical" {{ 'selected' if equipment.criticality == 'critical' else '' }}>Critical</option>
                                    </select>
                                    <div class="form-text">How critical is this equipment to operations?</div>
                                </div>
                            </div>
                            
                            <!-- Technical Details -->
                            <div class="col-md-6">
                                <h6 class="mb-3">Technical Details</h6>
                                
                                <div class="mb-3">
                                    <label for="manufacturer" class="form-label">Manufacturer</label>
                                    <input type="text" class="form-control" id="manufacturer" name="manufacturer" value="{{ equipment.manufacturer or '' }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="model" class="form-label">Model</label>
                                    <input type="text" class="form-control" id="model" name="model" value="{{ equipment.model or '' }}">
                                </div>
                                
                                                            <div class="mb-3">
                                <label for="serial_number" class="form-label">Serial Number</label>
                                <input type="text" class="form-control" id="serial_number" name="serial_number" value="{{ equipment.serial_number or '' }}">
                            </div>
                            
                            <div class="mb-3">
                                <label for="purchase_date" class="form-label">Purchase Date</label>
                                <input type="date" class="form-control" id="purchase_date" name="purchase_date" 
                                       value="{{ equipment.purchase_date.strftime('%Y-%m-%d') if equipment.purchase_date else '' }}">
                                <div class="form-text">Date when the equipment was purchased</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="warranty_expiry" class="form-label">Warranty Expiry Date</label>
                                <input type="date" class="form-control" id="warranty_expiry" name="warranty_expiry" 
                                       value="{{ equipment.warranty_expiry.strftime('%Y-%m-%d') if equipment.warranty_expiry else '' }}">
                                <div class="form-text">Date when the warranty expires</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="location_id" class="form-label">Location</label>
                                <select class="form-select" id="location_id" name="location_id">
                                    <option value="">Select Location</option>
                                    {% for location in locations %}
                                        <option value="{{ location.id }}" {{ 'selected' if equipment.location_id == location.id else '' }}>
                                            {{ location.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Choose from available locations or leave blank</div>
                            </div>
                                
                                <div class="mb-3">
                                    <label for="department_id" class="form-label">Department</label>
                                    <select class="form-select" id="department_id" name="department_id">
                                        <option value="">Select Department</option>
                                        {% for department in departments %}
                                            <option value="{{ department.id }}" {{ 'selected' if equipment.department_id == department.id else '' }}>
                                                {{ department.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">Choose from available departments or leave blank</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="mb-3">Description & Specifications</h6>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Brief description of the equipment">{{ equipment.description or '' }}</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="specifications" class="form-label">Technical Specifications</label>
                                    <textarea class="form-control" id="specifications" name="specifications" rows="4" placeholder="Technical specifications, operating parameters, etc.">{{ equipment.specifications or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="row">
                            <div class="col-12">
                                <hr class="my-4">
                                <div class="d-flex justify-content-between">
                                    <a href="/equipment/{{ equipment.id }}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Update Equipment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryType" class="form-label">Category Type</label>
                        <select class="form-select" id="categoryType" required>
                            <option value="equipment">Equipment</option>
                            <option value="inventory">Inventory</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addCategory()">Add Category</button>
            </div>
        </div>
    </div>
</div>

<script>
function addCategory() {
    const name = document.getElementById('categoryName').value;
    const type = document.getElementById('categoryType').value;
    const description = document.getElementById('categoryDescription').value;
    
    if (!name) {
        alert('Please enter a category name');
        return;
    }
    
    fetch('/categories/new', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}&description=${encodeURIComponent(description)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add the new category to the dropdown
            const categorySelect = document.getElementById('category');
            const option = document.createElement('option');
            option.value = data.category.name;
            option.textContent = data.category.name;
            categorySelect.appendChild(option);
            
            // Close modal and show success message
            bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
            alert('Category added successfully!');
            
            // Clear form
            document.getElementById('addCategoryForm').reset();
        } else {
            alert('Error adding category: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding category');
    });
}
</script>
{% endblock %} 